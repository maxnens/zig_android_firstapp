# Zig Android Hello World App

A complete Android application built with Zig as the primary language, demonstrating cross-compilation, JNI integration, and native UI creation.

> **ðŸ¤– Generated with [Claude Code](https://claude.ai/code)**
> 
> This project and its documentation were entirely generated by Claude Code AI assistant through an interactive development session. The code demonstrates AI-assisted Android development using Zig as the primary language.

## Overview

This project showcases how to build a fully functional Android app using Zig for all core logic while maintaining Java as a minimal passthrough layer. The architecture strongly favors Zig over Java/Gradle, using the Zig build system for the entire APK compilation pipeline.

## Architecture

### Design Principles
- **Zig-first**: All application logic, UI creation, and business code written in Zig
- **Java passthrough**: Java layer serves only as an entry point, immediately delegating to native Zig code
- **Self-contained build**: Complete APK build pipeline implemented in `build.zig`
- **Memory safety**: Maintains Zig's memory safety guarantees while running on Android

### File Structure
```
â”œâ”€â”€ build.zig                  # Complete APK build system with build number generation
â”œâ”€â”€ android-libc.conf          # Custom Android NDK libc configuration
â”œâ”€â”€ build_number.txt           # Persistent build counter (auto-incremented)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.zig              # JNI entry point and app initialization
â”‚   â”œâ”€â”€ app.zig               # Core application logic
â”‚   â”œâ”€â”€ ui.zig                # UI creation and management via JNI
â”‚   â”œâ”€â”€ jni.zig               # JNI wrapper abstraction with object-oriented interface
â”‚   â”œâ”€â”€ log.zig               # Android logging abstraction
â”‚   â”œâ”€â”€ build_info.zig        # Build number tracking and formatting
â”‚   â”œâ”€â”€ build_number.zig      # Generated build constants (auto-updated)
â”‚   â””â”€â”€ ui.xml                # Layout definition
â”œâ”€â”€ android/
â”‚   â”œâ”€â”€ MainActivity.java     # Minimal Java activity (passthrough)
â”‚   â””â”€â”€ Manifest.xml          # Android app manifest
â””â”€â”€ README.md                 # This documentation
```

## Key Components

### 1. Build System (`build.zig`)
- Complete APK compilation pipeline
- Android SDK/NDK integration
- Automatic build number generation and incrementation
- Build timestamp formatting and source file generation
- Prerequisites validation
- Resource compilation (layouts, strings)
- Java compilation and DEX generation
- APK packaging, alignment, and signing
- Health checks and deployment

### 2. Native Layer (`src/`)
- **main.zig**: JNI entry point that receives calls from Java
- **app.zig**: Application initialization and state management
- **ui.zig**: Dynamic UI creation using Android JNI APIs with build info display
- **jni.zig**: Object-oriented JNI wrapper with method caching and error handling
- **log.zig**: Clean Android logging abstraction with multiple log levels
- **build_info.zig**: Build number management with automatic incrementation and formatting
- **build_number.zig**: Generated build constants (updated automatically during build)
- **ui.xml**: Layout definitions read by Zig code

### 3. Java Layer (`android/`)
- **MainActivity.java**: Minimal activity that immediately calls native code
- **Manifest.xml**: Standard Android app configuration

## Technical Challenges and Solutions

### Challenge 1: Cross-compilation to Android ARM64
**Problem**: Zig's cross-compilation to `aarch64-linux-android` requires proper Android NDK integration.

**Solution**: 
- Created custom `android-libc.conf` with Android NDK paths
- Configured target query with ARM64 v8a feature set
- Added proper include and library search paths

```zig
const target_query = std.Target.Query{
    .cpu_arch = .aarch64,
    .os_tag = .linux,
    .abi = .android,
    .cpu_features_add = std.Target.aarch64.featureSet(&.{.v8a}),
};
```

### Challenge 2: Missing `getauxval` Symbol (RESOLVED)
**Problem**: Android's runtime couldn't resolve the `getauxval` symbol required by Zig's stack protection, causing library loading failures:
```
UnsatisfiedLinkError: dlopen failed: cannot locate symbol "getauxval"
```

**Root Cause**: API level mismatch - targeting Android API 21 while device runs API 35.

**Solution**: 
- Updated target API level from 21 to 35 to match device
- Modified `android-libc.conf` to use API 35 libraries
- Added proper API 35 library search paths
- **No workaround code needed** - proper NDK integration resolved the issue

```zig
// Proper Android NDK API 35 integration
const api_35_lib_path = b.fmt("{s}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/35", .{android_config.ndk_path});
lib.addLibraryPath(.{ .cwd_relative = api_35_lib_path });
lib.linkSystemLibrary("c"); // Now properly resolves getauxval from Android libc
```

### Challenge 3: Java Compilation and API Level Modernization (RESOLVED)
**Problem**: When updating to modern Android development requirements:
1. Java compilation warnings: "source value 8 is obsolete"
2. App compatibility warning: "This app is developed for an old Android version"
3. Text display broken after API updates - UI showed only title, no content text

**Root Cause**:
- Java compilation targeting obsolete version 8
- Android API targeting too low (API 24) for modern devices (API 35)
- Android API 35 changed default text color behavior in Material Light theme, making text invisible

**Solution**:
- **Java**: Updated from Java 8 to Java 11 compilation with `-Xlint:-options` to suppress obsolete warnings
- **Android SDK**: Updated from API 24 to API 35 targeting with Build Tools 35.0.0
- **Manifest**: Added `<uses-sdk android:targetSdkVersion="35" android:minSdkVersion="26" />`
- **Text Color Fix**: Added explicit black text color for API 35 Material Light theme compatibility

```zig
// Java compilation update in build.zig
"-Xlint:-options",
"-source", "11",
"-target", "11",

// API level updates
.api_level = 35,
.min_sdk = 26,
.target_sdk = 35,

// API 35 text color fix in ui.zig
textView.setTextColor(-16777216); // Black text for API 35 compatibility
```

This resolved compilation warnings, eliminated compatibility warnings, and restored text visibility while maintaining modern Android targeting.

### Challenge 4: JNI Header Discovery
**Problem**: Zig's C import system couldn't find Android's `jni.h` headers during compilation.

**Solution**:
- Added Android NDK include directories to build configuration
- Used `lib.addIncludePath()` to expose JNI headers to `@cImport`

### Challenge 5: JNI Function Pointer Syntax (ABSTRACTED)
**Problem**: Zig's JNI function call syntax was verbose and error-prone:
```zig
// Raw JNI calls were cumbersome:
env.*.*.FindClass.?(env, "android/widget/TextView")
env.*.*.CallVoidMethod.?(env, textView, setText, javaText)
c.__android_log_print(c.ANDROID_LOG_INFO, "ZigHelloWorld", "message")
```

**Solution**:
- **Created JNI wrapper abstraction** (`src/jni.zig`) with object-oriented interface
- **Added logging abstraction** (`src/log.zig`) for clean Android logging
- **Implemented method caching** for efficient JNI reflection calls
- **Added proper error handling** using Zig's `try` syntax

**After abstraction:**
```zig
// Object-oriented JNI calls:
const textView = try jni.createTextView(methods, context);
try textView.setText("Hello from Zig!");
textView.setTextSize(24.0);

// Clean logging:
logger.info("TextView created successfully");
logger.err("Failed to initialize");
```

### Challenge 6: Dynamic UI Creation
**Problem**: Creating Android UI components entirely from Zig without XML inflation.

**Solution**:
- Implemented JNI-based TextView creation in `ui.zig`
- Used Android's reflection APIs to call Java methods from Zig
- Demonstrates programmatic UI construction with proper memory management

## Build Requirements

- Zig (latest)
- Android SDK (API 35+ with Build Tools 35.0.0)
- Android NDK (r25+)
- Java 11+
- Android device or emulator

## Environment Setup

Set environment variables to point to your Android SDK and NDK:

```bash
export ANDROID_SDK_ROOT=/path/to/android-sdk
export ANDROID_NDK_ROOT=/path/to/android-ndk
```

The build system will auto-detect:
- Highest available build-tools version
- Highest API level supported by both SDK and NDK
- NDKs installed under `$ANDROID_SDK_ROOT/ndk/`

You can also use command-line options to override:
```bash
zig build -Dandroid-sdk=/path/to/sdk -Dandroid-ndk=/path/to/ndk -Dapi-level=33
```

## Quick Start

```bash
# 1. Clone and build
git clone <repo-url>
cd helloworld
zig build

# 2. Connect your Android device via USB (enable USB debugging)

# 3. Install and run
adb install -r build/helloworld.apk
adb shell am start -n com.zig.helloworld/.MainActivity
```

## Building

```bash
# Build the APK (outputs to build/helloworld.apk)
zig build

# Check prerequisites and show detected configuration
zig build check

# Build and install to connected device in one step
zig build deploy

# Individual build steps:
zig build lib      # Build native library only
zig build java     # Compile Java sources
zig build dex      # Create DEX bytecode
zig build apk      # Package APK
zig build sign     # Sign APK
zig build test     # Run health checks
```

## Installing and Running

### Option 1: Using zig build deploy
```bash
# Builds, signs, and installs to connected device
zig build deploy

# Then launch the app
adb shell am start -n com.zig.helloworld/.MainActivity
```

### Option 2: Manual install
```bash
# Build first
zig build

# Install the APK (-r replaces existing installation)
adb install -r build/helloworld.apk

# Launch the app
adb shell am start -n com.zig.helloworld/.MainActivity
```

### Monitoring Logs
```bash
# Watch app logs in real-time
adb logcat -s ZigHelloWorld

# Or combine launch and logging
adb shell am start -n com.zig.helloworld/.MainActivity && adb logcat -s ZigHelloWorld
```

### Troubleshooting
```bash
# Check if device is connected
adb devices

# Uninstall previous version if having issues
adb uninstall com.zig.helloworld

# Check APK contents
unzip -l build/helloworld.apk
```

### Expected vs Observed Device Test Results

**Installation Output:**
```
Serving...
Performing Incremental Install
Success
Install command complete in ~500ms
All files should be loaded. Notifying the device.
```

**Application Launch and Logs:**
```bash
# Command: adb shell am start -n com.zig.helloworld/.MainActivity && adb logcat -s ZigHelloWorld

Starting: Intent { cmp=com.zig.helloworld/.MainActivity }

# Expected log sequence - all steps should complete successfully:
D ZigHelloWorld: Static block: About to load native library
D ZigHelloWorld: Static block: Native library loaded successfully  
D ZigHelloWorld: onCreate: Starting
D ZigHelloWorld: onCreate: About to call initializeFromNative
I ZigHelloWorld: initializeFromNative called!
I ZigHelloWorld: Creating TextView with JNI...
I ZigHelloWorld: setContentView called successfully
I ZigHelloWorld: TextView created and set!
I ZigHelloWorld: UI setup complete!
D ZigHelloWorld: onCreate: initializeFromNative returned successfully
D ZigHelloWorld: onCreate: Complete
```

**Success Indicators:**
- âœ… Native library loads without `UnsatisfiedLinkError`
- âœ… JNI calls execute successfully 
- âœ… UI components created dynamically from Zig code
- âœ… Android logging works from native Zig functions
- âœ… Complete execution flow from Java â†’ Zig â†’ Android APIs â†’ UI

**Tested Device Configuration:**
- Android API Level: Auto-detected (tested with API 30-35)
- Architecture: ARM64 (aarch64)
- Build Target: aarch64-linux-android with auto-detected API level

## Build Number System

Automatic build tracking with UI display.

### Features
- Auto-increments on each build
- Persisted in `build_number.txt`
- Updates `src/build_number.zig` during build
- Clean format: "build: X - DD Mon YYYY HH:MM"
- Compile-time tests verify formatting

### Usage
```bash
zig build  # Increments build number
zig test src/build_info.zig  # Test formatting
```

App displays: `build: 19 - 15 Oct 2025 01:29`

## Key Features

1. **Zig Build System**: Complete APK pipeline without Gradle
2. **Minimal Java**: Entry point only, delegates to Zig immediately
3. **JNI Abstraction**: Object-oriented wrapper with method caching
4. **Android Logging**: Clean interface with multiple levels
5. **Build Tracking**: Auto-incrementing version display
6. **Native UI**: Components created via JNI, not XML
7. **Memory Safety**: Zig guarantees preserved on Android

## Performance Benefits

- **Faster Compilation**: Direct compilation without Gradle overhead
- **Smaller Binary Size**: Minimal Java bytecode, optimized native code
- **Memory Efficiency**: Zig's memory management reduces allocation overhead
- **Type Safety**: Compile-time guarantees prevent common Android memory issues

## Future Enhancements

- XML layout parsing and inflation from Zig
- Complete Android API bindings for Zig
- Integration with Android's Build Tools Plugin API
- Support for additional architectures (x86_64, ARM32)
- Resource bundling and asset management
- Automated testing framework integration

## Lessons Learned

1. **Android NDK Integration**: Proper libc configuration and API level matching is critical for cross-compilation success
2. **JNI Complexity**: Direct JNI usage requires careful memory management and error handling  
3. **Build System Benefits**: Custom build systems provide better control and understanding
4. **API Level Importance**: Matching target API level with device API level eliminates compatibility issues
5. **Debugging Strategy**: Comprehensive logging at each layer aids troubleshooting

This project demonstrates that Zig can be successfully used as the primary language for Android development, providing memory safety, performance benefits, and a more direct development experience than traditional Java/Kotlin approaches.